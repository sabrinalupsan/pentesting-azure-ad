### Download MSI here: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli

### Connect
> az login

> az login -u \<username>@\<domain name>.onmicrosoft.com -p \<password>

### If the user has no permissions on the subscription
> az login -u \<username>@\<domain name>.onmicrosoft.com -p \<password> --allow-no-subscriptions

### List all users in Azure AD
> az ad user list --output table 

> az ad user list --query "[].[displayName]" -o table 

See only principal name and display name
> az ad user list --query "[].[userPrincipalName,displayName]" --output table

Get details about the current tenant:
> az account tenant list

Get details about the current subscription:
> az account subscription list

List the current signed-in user
> az ad signed-in-user show

Show details of a spcific user
> az ad user show --id \<username>@\<domain name>.onmicrosoft.com

All users synced from on-prem
>az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"

All users from Azure AD
>az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"

Search for users with "admin" in name (cmd)
> az ad user list --query "[?contains(displayName,'admin')].displayName"

Search for users with "admin" in name (ps)
> az ad user list | ConvertFrom-Json | %{$_.displayName -match "admin"} 

### Groups
List all groups
>az ad group list

>az ad group list --query "[].[displayName]" -o table

Enumerate a specific group using display names or object id
> az ad group show -g "\<group name>"

> az ad group show -g \<objectID>

Search for groups with "admin" in name (case sensitive) (cmd)
> az ad group list --query "[?contains(displayName,'admin')].displayName"

Search for groups with "admin" in name (case sensitive) (ps)
> az ad group list --query "[?contains(displayName,'admin')].displayName"

All groups that are synced from on-prem
> az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"

All groups that are from Azure AD
> az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"

Get members of group
> az ad group member list -g "VM Admins" --query "[].[displayName]" -o table

Check if a usr is a member of a specific group
> az ad group member check --group "\<group name>" --member-id \<objectID>

Get the IDs of the groups a specific member is a part of
> az ad group get-member-groups -g "\<group name>" 

### AAD Apps
Get all the application objects registered with the current tenant
> az ad app list

>az ad app list --query "[].[displayName]" -o table

Get all details about app using identifier ID, app ID, obj ID
> az ad app show --id \<objectID>

Get an app based on display name
cmd:
> az ad app list --query "[?contains(displayName,'app')].displayName"

powershell:
>az ad app list | ConvertFrom-Json | %{$_.displayName -match "app"} 

Get owner of an app
> az ad app owner list --id \<objectID> --query "[].[displayName]" -o table

List apps that have password credentials
> az ad app list --query "[?passwordCredentials != null].displayName"

### AAD Service Principals
Get all service principals
> az ad sp list --all

>az ad sp list --all --query "[].[displayName]" -o table

Get all details about a service principal using service principal id or object id
> az ad sp show --id \<objectID>

Get a service principal based on the display name (cmd)
> az ad sp list --all --query "[?contains(displayName,'app')].displayName"

Get a service principal based on the display name (cmd)
>az ad sp list --all | ConvertFrom-Json | %{$_.displayName -match "app"}

Get owner of a service principal
> az ad sp owner list --id \<objectID> --query "[].[displayName]" -o table

Get service principals owned by the current user
> az ad sp list --show-mine

List apps that have password credentials
> az ad sp list --all --query "[?passwordCredentials != null].displayName"

List apps that have key credentials (use of certificate authentication)
> az ad sp list --all --query "[?keyCredentials != null].displayName"

List the names of the app services
> az webapp list --query "[].[name]" -o table

List the app services but with details
> az webapp list

List the names of the Function Apps
> az functionapp list --query "[].[name]" -o table

List the storage account
> az storage account list

List readable keyvaults
> az keyvault list

### Access tokens

Request an ARM access token
> az account get-access-token

Request an AAD graph access token
> az account get-access-token --resource-type ms-graph 

Steal tokens: az cli stores access tokens in clear text in C:\Users\\[username]\.Azure\accessTokens.json

Moreover, info about subscription can be found in azureProfile.json

To clear access tokens:
> az logout

### Privilege Escalation
If you have a reverse shell, check if the user is logged-in to az cli on the machine
> whoami

>az ad signed-in-user show

Get info on automation accounts (might not return anything)
>az extension add --upgrade -n automation

>az automation account list

Check for objects owned by the user
>az ad signed-in-user list-owned-objects

Request a token for AAD Graph to be able to interact with Azure AD
>az account get-access-token --resource-type aad-graph

See info about a user
>az ad user show --id \<username>@\<domain name>.onmicrosoft.com